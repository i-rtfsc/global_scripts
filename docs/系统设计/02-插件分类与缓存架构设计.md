# Global Scripts V3 插件分类与缓存架构设计

## 📋 概述

本文档详细说明Global Scripts V3的插件分类机制、缓存架构设计以及状态管理方案，提供了完整的插件生命周期管理策略。

## 🔧 插件分类设计

### 1. 插件类型定义

Global Scripts V3将插件分为三种类型，每种类型有不同的加载策略和管理方式：

#### 1.1 系统命令 (System Plugins)
- **定义**: 系统核心命令，提供基础功能
- **位置**: `system/` 目录下
- **插件列表**: 
  - `help` - 显示帮助信息
  - `version` - 显示版本信息  
  - `status` - 显示状态信息
  - `plugins` - 管理插件
- **加载策略**: 必须加载，不受配置文件影响
- **状态管理**: 不支持enable/disable操作，永远处于enabled状态
- **更新策略**: 基本不变，可以持久化缓存

#### 1.2 本工程自带插件 (Core Plugins)
- **定义**: 本工程开发的官方插件
- **位置**: `plugins/` 目录下
- **加载策略**: 受配置文件 `config/.gsconf` 影响
- **状态管理**: 支持enable/disable操作
- **更新策略**: 每次 `source gs_env.sh` 时重新扫描和缓存

#### 1.3 第三方插件 (3rd Plugins)
- **定义**: 用户或第三方开发的插件
- **位置**: `custom/` 目录下
- **加载策略**: 受配置文件 `config/.gsconf` 影响
- **状态管理**: 支持enable/disable操作
- **更新策略**: 每次 `source gs_env.sh` 时重新扫描和缓存

### 2. 插件目录结构

```bash
global_scripts-augment/
├── system/                    # 系统命令
│   ├── help/
│   │   ├── help.meta
│   │   └── help.sh
│   ├── version/
│   ├── status/
│   └── plugins/
├── plugins/                   # 本工程自带插件
│   ├── generator/
│   │   ├── generator.meta
│   │   └── generator.sh
│   └── [其他core插件]/
├── custom/                    # 第三方插件
│   ├── [用户插件1]/
│   ├── [用户插件2]/
│   └── [其他3rd插件]/
└── config/
    ├── .gsconf               # 插件配置文件
    └── cache/               # 缓存目录
        ├── system_plugins.cache
        ├── core_plugins.cache
        └── 3rd_plugins.cache
```

## 🗄️ 缓存架构设计

### 1. 缓存文件分离

采用三个独立的缓存文件，分别管理不同类型的插件：

#### 1.1 系统命令缓存
- **文件**: `config/cache/system_plugins.cache`
- **内容**: 系统命令的插件信息
- **更新策略**: 持久化，基本不变
- **维护**: 只在系统升级时更新

#### 1.2 本工程插件缓存  
- **文件**: `config/cache/core_plugins.cache`
- **内容**: 本工程自带插件信息
- **更新策略**: 每次 `source gs_env.sh` 重新生成
- **维护**: 动态更新，响应插件的启用/禁用状态变化

#### 1.3 第三方插件缓存
- **文件**: `config/cache/3rd_plugins.cache` 
- **内容**: 第三方插件信息
- **更新策略**: 每次 `source gs_env.sh` 重新生成
- **维护**: 动态更新，响应插件的启用/禁用状态变化

### 2. 统一缓存格式

所有缓存文件采用统一的数据格式：

```bash
PLUGIN:name:version:status:commands_count:description:commands
```

#### 2.1 字段说明
- **name**: 插件名称（唯一标识符）
- **version**: 插件版本号
- **status**: 插件状态（enabled/disabled）
- **commands_count**: 该插件提供的命令数量
- **description**: 插件功能描述
- **commands**: 该插件的所有命令列表（逗号分隔）

#### 2.2 格式示例
```bash
# system_plugins.cache
PLUGIN:help:1.0.0:enabled:1:显示帮助信息:gs-help
PLUGIN:version:1.0.0:enabled:1:显示版本信息:gs-version
PLUGIN:status:1.0.0:enabled:1:显示状态信息:gs-status
PLUGIN:plugins:1.0.0:enabled:5:管理插件:gs-plugins list,gs-plugins info,gs-plugins enable,gs-plugins disable,gs-plugins reload

# core_plugins.cache  
PLUGIN:generator:1.0.0:enabled:2:自动生成插件的工具:gs-generate-plugin,gs-generate-system
PLUGIN:android:2.1.0:disabled:12:Android开发工具集:gs-android-device-list,gs-android-adb-shell,...

# 3rd_plugins.cache
PLUGIN:custom-tool:1.5.0:enabled:3:用户自定义工具:gs-custom-cmd1,gs-custom-cmd2,gs-custom-cmd3
```

## ⚙️ 配置文件设计

### 1. 配置文件位置
- **路径**: `config/.gsconf`
- **格式**: 简单的配置项格式
- **作用**: 控制 core plugins 和 3rd plugins 的加载

### 2. 配置文件格式

```bash
# Global Scripts V3 插件配置
# 配置格式: CATEGORY:PLUGIN_NAME:STATUS

# Core Plugins配置
CORE:generator:enabled
CORE:android:disabled
CORE:git:enabled

# 3rd Plugins配置  
3RD:custom-tool:enabled
3RD:user-plugin:disabled
```

### 3. 配置项说明
- **CATEGORY**: 插件类别（CORE/3RD）
- **PLUGIN_NAME**: 插件名称
- **STATUS**: 状态（enabled/disabled）

## 🔄 状态管理机制

### 1. 插件状态定义
- **enabled**: 插件已启用，命令可用
- **disabled**: 插件已禁用，命令不可用

### 2. 状态管理规则

#### 2.1 系统命令状态管理
- **固定状态**: 永远为 `enabled`
- **操作限制**: 不支持 `gs-plugins enable/disable` 操作
- **错误处理**: 尝试禁用系统命令时显示错误信息

#### 2.2 Core/3rd插件状态管理
- **动态状态**: 支持 `enabled`/`disabled` 切换
- **操作支持**: 支持 `gs-plugins enable/disable` 操作
- **状态同步**: 状态变化时同步更新缓存文件和配置文件

### 3. 状态变更流程

#### 3.1 启用插件流程
```bash
gs-plugins enable <plugin_name>
↓
1. 检查插件类型（system/core/3rd）
2. 验证插件是否存在
3. 更新 .gsconf 配置文件
4. 更新对应的缓存文件
5. 重新加载插件（如果需要）
6. 显示操作结果
```

#### 3.2 禁用插件流程  
```bash
gs-plugins disable <plugin_name>
↓
1. 检查插件类型（禁止操作system类型）
2. 验证插件是否存在且已启用
3. 更新 .gsconf 配置文件  
4. 更新对应的缓存文件
5. 卸载插件命令（如果需要）
6. 显示操作结果
```

## 🔧 实施方案

### 1. 缓存生成时机
- **系统启动**: `source gs_env.sh` 时
- **状态变更**: 执行 `gs-plugins enable/disable` 时
- **手动刷新**: `gs-plugins reload` 时

### 2. 缓存更新策略
- **system_plugins.cache**: 只在系统版本更新时重新生成
- **core_plugins.cache**: 每次环境初始化时重新扫描生成
- **3rd_plugins.cache**: 每次环境初始化时重新扫描生成

### 3. 性能优化
- **缓存读取**: 优先从缓存读取，避免实时文件扫描
- **增量更新**: 状态变更时只更新相关缓存文件
- **并行处理**: 三种插件类型可并行扫描和缓存

### 4. 错误处理
- **缓存缺失**: 自动重新生成缓存
- **配置错误**: 提供详细的错误信息和修复建议
- **插件冲突**: 检测并报告插件名称冲突

## 📊 设计优势

### 1. 清晰的职责分离
- 系统命令保证系统稳定性
- Core插件提供丰富功能
- 3rd插件支持用户扩展

### 2. 高效的性能表现
- 分离缓存减少不必要的扫描
- 状态管理避免重复加载
- 配置驱动提供灵活控制

### 3. 良好的扩展性
- 支持任意数量的插件类型扩展
- 统一的缓存格式便于维护
- 模块化设计便于功能增强

### 4. 可靠的状态一致性
- 配置文件与缓存文件双重保障
- 原子操作确保状态一致性
- 完善的错误恢复机制

## 🚀 实施计划

### 第一阶段：基础架构
1. 创建三个独立的缓存文件
2. 实现统一的缓存格式解析
3. 建立配置文件.gsconf机制

### 第二阶段：状态管理
1. 实现插件状态的读取和更新
2. 开发enable/disable操作逻辑
3. 添加状态一致性检查

### 第三阶段：集成优化
1. 集成到gs_env.sh的扫描流程
2. 优化gs-plugins命令的缓存读取
3. 完善错误处理和用户反馈

### 第四阶段：测试验证
1. 编写完整的单元测试
2. 进行系统集成测试
3. 性能基准测试和优化

---

*本设计文档定义了Global Scripts V3插件管理的核心架构，为后续开发提供了清晰的技术规范和实施指导。*