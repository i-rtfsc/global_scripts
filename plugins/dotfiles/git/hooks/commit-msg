#!/usr/bin/env bash
# ============================================
# Global Git Commit Message Hook
# Validates commit messages against Conventional Commits v1.0.0
# Spec: https://www.conventionalcommits.org/
# Generated by: Global Scripts - dotfiles/git plugin
# ============================================

# Commit message file
COMMIT_MSG_FILE=$1
COMMIT_MSG=$(cat "$COMMIT_MSG_FILE")

# Color codes
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# Extract first line (header) - body and footer are optional
HEADER=$(echo "$COMMIT_MSG" | head -n 1)

# Allow special commits
if [[ "$HEADER" =~ ^Merge || "$HEADER" =~ ^Revert || "$HEADER" =~ ^# ]]; then
    exit 0
fi

# Conventional Commits pattern (commitlint standard)
# Format: <type>[optional scope][optional !]: <subject>
# Breaking change can be indicated by ! before :
# Examples:
#   feat(auth): add login feature
#   fix!: resolve critical security issue
#   docs: update installation guide
#   feat(api)!: breaking API changes

# Standard types from commitlint config-conventional
TYPES="build|chore|ci|docs|feat|fix|perf|refactor|revert|style|test"

# Pattern breakdown:
# ^                          - Start of line
# ($TYPES)                   - Required type
# (\([^)]+\))?               - Optional scope (any chars except ))
# !?                         - Optional ! for breaking change
# :\s                        - Required colon and space
# .+                         - Subject (at least one char)
# [^\.]\s*$                  - Should not end with period
PATTERN="^($TYPES)(\([^)]+\))?!?: .+[^\.]$"

# Validate header format
if ! [[ "$HEADER" =~ $PATTERN ]]; then
    echo -e "${RED}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo -e "${RED}✗ Commit message format error!${NC}"
    echo -e "${RED}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo ""
    echo -e "${YELLOW}Your commit header (first line):${NC}"
    echo -e "  ${HEADER}"
    echo ""
    echo -e "${BLUE}Expected format (Conventional Commits v1.0.0):${NC}"
    echo -e "  ${GREEN}<type>[optional scope][optional !]: <subject>${NC}"
    echo ""
    echo -e "${CYAN}Full structure:${NC}"
    echo -e "  ${GREEN}<type>[optional scope]: <subject>${NC}"
    echo -e "  "
    echo -e "  ${GREEN}[optional body]${NC}"
    echo -e "  "
    echo -e "  ${GREEN}[optional footer(s)]${NC}"
    echo ""
    echo -e "${BLUE}Valid types (commitlint standard):${NC}"
    echo -e "  ${GREEN}build${NC}    - Changes to build system or dependencies"
    echo -e "  ${GREEN}chore${NC}    - Other changes (maintenance, tools, etc.)"
    echo -e "  ${GREEN}ci${NC}       - CI/CD configuration changes"
    echo -e "  ${GREEN}docs${NC}     - Documentation only changes"
    echo -e "  ${GREEN}feat${NC}     - A new feature"
    echo -e "  ${GREEN}fix${NC}      - A bug fix"
    echo -e "  ${GREEN}perf${NC}     - Performance improvements"
    echo -e "  ${GREEN}refactor${NC} - Code refactoring (no feature or fix)"
    echo -e "  ${GREEN}revert${NC}   - Revert a previous commit"
    echo -e "  ${GREEN}style${NC}    - Code style/formatting (no logic change)"
    echo -e "  ${GREEN}test${NC}     - Adding or updating tests"
    echo ""
    echo -e "${BLUE}Examples:${NC}"
    echo -e "  ${GREEN}feat(auth): add user login feature${NC}"
    echo -e "  ${GREEN}fix(api): resolve null pointer in user service${NC}"
    echo -e "  ${GREEN}docs: update README installation guide${NC}"
    echo -e "  ${GREEN}refactor(utils): simplify string parsing logic${NC}"
    echo -e "  ${GREEN}feat!: breaking change in API${NC}"
    echo -e "  ${GREEN}fix(core)!: critical security fix with breaking changes${NC}"
    echo ""
    echo -e "${YELLOW}Rules:${NC}"
    echo -e "  • Scope is optional, in parentheses: ${GREEN}(api)${NC}, ${GREEN}(core)${NC}, etc."
    echo -e "  • Use ${GREEN}!${NC} before ${GREEN}:${NC} to indicate breaking changes"
    echo -e "  • Subject should NOT end with a period"
    echo -e "  • Header should be <= 72 characters (recommended)"
    echo -e "  • Body and footer are optional (separated by blank lines)"
    echo -e "${RED}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    exit 1
fi

# Check header length (warning only, not blocking)
HEADER_LENGTH=${#HEADER}
if [ "$HEADER_LENGTH" -gt 72 ]; then
    echo -e "${YELLOW}⚠ Warning: Header length is $HEADER_LENGTH chars (recommended: <= 72)${NC}"
fi

# Success
echo -e "${GREEN}✓ Commit message format is valid${NC}"
exit 0
