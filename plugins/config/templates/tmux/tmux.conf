# ============================================================================
# Global Scripts Tmux 配置文件 - 现代化的终端复用器配置
# 基于最佳实践，提供高效的终端管理体验
# 支持 Tmux 2.6+ 版本
# ============================================================================

# ============================================================================
# 基础设置 - 核心配置选项
# ============================================================================

# 设置默认终端模式为256色
set -g default-terminal "screen-256color"

# 启用真彩色支持 (需要终端支持)
set -ga terminal-overrides ",xterm-256color:Tc"

# 设置默认shell
set -g default-shell $SHELL

# 启用鼠标支持
set -g mouse on

# 设置历史缓冲区大小
set -g history-limit 10000

# 设置窗口和面板的索引从1开始 (默认从0开始)
set -g base-index 1
setw -g pane-base-index 1

# 窗口关闭后自动重新编号
set -g renumber-windows on

# 减少延迟时间，提高响应速度
set -sg escape-time 0

# 设置重复按键的时间间隔
set -g repeat-time 600

# 设置显示面板编号的时间
set -g display-panes-time 800

# 设置状态消息显示时间
set -g display-time 1000

# ============================================================================
# 按键绑定配置 - 自定义快捷键
# ============================================================================

# 更改前缀键为 Ctrl-a (更符合screen用户习惯，也更容易按)
unbind C-b
set -g prefix C-a
bind C-a send-prefix

# 重新加载配置文件
bind r source-file ~/.tmux.conf \; display-message "配置已重新加载!"

# ============================================================================
# 窗口和面板管理
# ============================================================================

# 使用更直观的按键分割窗口
bind | split-window -h -c "#{pane_current_path}"  # 垂直分割 (|)
bind - split-window -v -c "#{pane_current_path}"  # 水平分割 (-)

# 取消默认的分割按键
unbind '"'
unbind %

# 创建新窗口时保持当前路径
bind c new-window -c "#{pane_current_path}"

# 使用 vim 风格的面板切换
bind h select-pane -L    # 左
bind j select-pane -D    # 下  
bind k select-pane -U    # 上
bind l select-pane -R    # 右

# 使用 vim 风格的面板大小调整
bind -r H resize-pane -L 5   # 向左扩展
bind -r J resize-pane -D 5   # 向下扩展
bind -r K resize-pane -U 5   # 向上扩展
bind -r L resize-pane -R 5   # 向右扩展

# 快速切换到上一个窗口
bind a last-window

# 快速切换到上一个面板
bind Tab last-pane

# 窗口快速切换 (Alt + 数字)
bind -n M-1 select-window -t 1
bind -n M-2 select-window -t 2
bind -n M-3 select-window -t 3
bind -n M-4 select-window -t 4
bind -n M-5 select-window -t 5
bind -n M-6 select-window -t 6
bind -n M-7 select-window -t 7
bind -n M-8 select-window -t 8
bind -n M-9 select-window -t 9

# ============================================================================
# 复制模式配置 - vim 风格的文本选择和复制
# ============================================================================

# 使用 vim 按键风格
setw -g mode-keys vi

# 进入复制模式
bind Enter copy-mode

# vim 风格的选择和复制
bind -T copy-mode-vi v send-keys -X begin-selection
bind -T copy-mode-vi C-v send-keys -X rectangle-toggle
bind -T copy-mode-vi y send-keys -X copy-selection-and-cancel

# 粘贴
bind p paste-buffer

# 选择粘贴缓冲区
bind P choose-buffer

# ============================================================================
# 状态栏配置 - 美观实用的状态栏
# ============================================================================

# 启用状态栏
set -g status on

# 状态栏更新间隔
set -g status-interval 5

# 状态栏位置 (top/bottom)
set -g status-position bottom

# 状态栏左右对齐
set -g status-justify left

# 状态栏长度
set -g status-left-length 50
set -g status-right-length 100

# ============================================================================
# 颜色主题配置 - 现代化的颜色方案
# ============================================================================

# 状态栏颜色
set -g status-style 'bg=colour234,fg=colour255'

# 窗口列表颜色
setw -g window-status-style 'bg=colour234,fg=colour245'
setw -g window-status-current-style 'bg=colour39,fg=colour234,bold'

# 面板边框颜色
set -g pane-border-style 'fg=colour238'
set -g pane-active-border-style 'fg=colour39'

# 消息颜色
set -g message-style 'bg=colour39,fg=colour234,bold'

# 选择模式颜色
setw -g mode-style 'bg=colour39,fg=colour234,bold'

# ============================================================================
# 状态栏内容配置 - 显示有用的系统信息
# ============================================================================

# 左侧状态栏：会话信息
set -g status-left '#[fg=colour39,bold]#S #[fg=colour245]| '

# 右侧状态栏：系统信息
set -g status-right '#[fg=colour245]%Y-%m-%d #[fg=colour39,bold]%H:%M #[fg=colour245]| #[fg=colour39]#H'

# 窗口状态格式
setw -g window-status-format ' #I:#W '
setw -g window-status-current-format ' #I:#W '

# ============================================================================
# 高级功能配置
# ============================================================================

# 启用 focus events (与vim集成)
set -g focus-events on

# 设置剪贴板集成 (macOS)
if-shell "uname | grep -q Darwin" {
    bind -T copy-mode-vi y send-keys -X copy-pipe-and-cancel 'pbcopy'
    bind -T copy-mode-vi Enter send-keys -X copy-pipe-and-cancel 'pbcopy'
}

# 设置剪贴板集成 (Linux)
if-shell "uname | grep -q Linux" {
    bind -T copy-mode-vi y send-keys -X copy-pipe-and-cancel 'xclip -in -selection clipboard'
    bind -T copy-mode-vi Enter send-keys -X copy-pipe-and-cancel 'xclip -in -selection clipboard'
}

# ============================================================================
# 插件管理 - TPM (Tmux Plugin Manager)
# ============================================================================

# 插件列表
set -g @plugin 'tmux-plugins/tpm'              # 插件管理器
set -g @plugin 'tmux-plugins/tmux-sensible'    # 基础改进
set -g @plugin 'tmux-plugins/tmux-resurrect'   # 会话保存/恢复
set -g @plugin 'tmux-plugins/tmux-continuum'   # 自动保存会话

# ============================================================================
# 插件配置 - 断电克星
# ============================================================================

# tmux-resurrect 配置 - 会话恢复
set -g @resurrect-capture-pane-contents 'on'   # 保存面板内容
set -g @resurrect-strategy-vim 'session'       # vim会话恢复策略
set -g @resurrect-strategy-nvim 'session'      # neovim会话恢复策略
set -g @resurrect-save-bash-history 'on'       # 保存bash历史
set -g @resurrect-save-shell-history 'on'      # 保存shell历史

# tmux-continuum 配置 - 自动保存和恢复
set -g @continuum-restore 'on'                 # 启动时自动恢复
set -g @continuum-save-interval '15'           # 自动保存间隔(分钟)
set -g @continuum-boot 'on'                    # 系统启动时自动启动tmux
set -g @continuum-boot-options 'iterm'         # macOS使用iTerm启动
# set -g @continuum-boot-options 'gnome-terminal' # Linux使用gnome-terminal启动

# 程序恢复配置
set -g @resurrect-processes 'vim nvim man less more tail top htop watch ssh mosh'

# ============================================================================
# 自定义函数和脚本
# ============================================================================

# 快速创建开发环境
bind D new-window -n "dev" -c "#{pane_current_path}" \; \
       split-window -h -c "#{pane_current_path}" \; \
       split-window -v -c "#{pane_current_path}" \; \
       select-pane -t 0

# 显示所有会话
bind S choose-session

# 重命名会话
bind R command-prompt -I "#S" "rename-session '%%'"

# 重命名窗口
bind r command-prompt -I "#W" "rename-window '%%'"

# ============================================================================
# 条件配置 - 根据tmux版本调整配置
# ============================================================================

# Tmux 2.9+ 的配置调整
if-shell -b '[ "$(echo "$TMUX_VERSION >= 2.9" | bc)" = 1 ]' {
    set -g window-style 'fg=colour247,bg=colour236'
    set -g window-active-style 'fg=colour250,bg=black'
}

# ============================================================================
# 初始化插件管理器 (保持在文件最后)
# ============================================================================
run -b '~/.tmux/plugins/tpm/tpm'

# ============================================================================
# 使用说明
# ============================================================================

# 常用快捷键：
# Prefix + |          垂直分割窗口
# Prefix + -          水平分割窗口  
# Prefix + h/j/k/l    vim风格切换面板
# Prefix + H/J/K/L    调整面板大小
# Prefix + r          重新加载配置
# Prefix + Enter      进入复制模式
# Prefix + D          创建开发环境布局
# Alt + 1-9           快速切换窗口

# 插件快捷键：
# Prefix + I          安装插件 (首次使用需要先安装TPM)
# Prefix + U          更新插件  
# Prefix + Alt + u    卸载插件
# Prefix + Ctrl-s     手动保存会话 (断电克星)
# Prefix + Ctrl-r     手动恢复会话 (断电克星)
#
# 断电克星使用说明：
# 1. 首次使用需要安装TPM: git clone https://github.com/tmux-plugins/tpm ~/.tmux/plugins/tpm
# 2. 重新加载配置后按 Prefix + I 安装插件
# 3. 会话每15分钟自动保存，重启后自动恢复
# 4. 可以保存vim/nvim会话、shell历史、面板内容等
# 5. 系统重启后tmux会自动启动并恢复上次会话